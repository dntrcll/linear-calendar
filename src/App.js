import{useEffect,useState,useRef,useCallback,useMemo}from"react";import{signInWithPopup,signOut,setPersistence,browserLocalPersistence}from"firebase/auth";import{auth,provider}from"./firebase";import{collection,query,where,getDocs,addDoc,updateDoc,deleteDoc,doc,serverTimestamp,Timestamp}from"firebase/firestore";import{db}from"./firebase";

const APP={name:"Timeline",tagline:"Your Life, Beautifully Organized",spaceId:"0Ti7Ru6X3gPh9qNwv7lT",familySpaceId:"family_shared"};
const CFG={ppm:1.33,snap:15,hourH:80,weekHourH:60};
const LIGHT={bg:"#FAFAF8",sidebar:"#FFF",card:"#FFF",text:"#1A1A18",textSec:"#6B6B63",textMuted:"#9B9B8F",border:"#E8E8E3",grid:"#F5F5F0",accent:"#059669",accentHover:"#047857",accentLight:"#ECFDF5",accentGlow:"rgba(5,150,105,0.15)",shadow:"0 2px 8px rgba(0,0,0,0.04)",shadowHover:"0 4px 16px rgba(0,0,0,0.08)",error:"#DC2626",success:"#059669"};
const DARK={bg:"#0D0D0C",sidebar:"#111110",card:"#161615",text:"#FAFAF8",textSec:"#A8A8A0",textMuted:"#585850",border:"#262624",grid:"#1A1A18",accent:"#10B981",accentHover:"#34D399",accentLight:"#064E3B",accentGlow:"rgba(16,185,129,0.2)",shadow:"0 2px 8px rgba(0,0,0,0.3)",shadowHover:"0 4px 16px rgba(0,0,0,0.4)",error:"#EF4444",success:"#10B981"};
const CATS=[{id:"work",name:"Work",color:"#059669",lightBg:"#ECFDF5",darkBg:"#064E3B",icon:"ðŸ’¼"},{id:"personal",name:"Personal",color:"#8B5CF6",lightBg:"#F5F3FF",darkBg:"#4C1D95",icon:"ðŸŒŸ"},{id:"health",name:"Health",color:"#EC4899",lightBg:"#FDF2F8",darkBg:"#831843",icon:"ðŸ’ª"},{id:"family",name:"Family",color:"#F59E0B",lightBg:"#FFFBEB",darkBg:"#78350F",icon:"ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦"},{id:"social",name:"Social",color:"#3B82F6",lightBg:"#EFF6FF",darkBg:"#1E3A5F",icon:"ðŸŽ‰"},{id:"learning",name:"Learning",color:"#14B8A6",lightBg:"#F0FDFA",darkBg:"#134E4A",icon:"ðŸ“š"},{id:"urgent",name:"Urgent",color:"#EF4444",lightBg:"#FEF2F2",darkBg:"#7F1D1D",icon:"ðŸ”¥"}];
const QUOTES=[{text:"The secret of getting ahead is getting started.",author:"Mark Twain"},{text:"The only way to do great work is to love what you do.",author:"Steve Jobs"},{text:"Success is not final, failure is not fatal.",author:"Winston Churchill"}];
const CSS=`@import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@400;500;600&display=swap');:root{--font-display:'Playfair Display',serif;--font-body:'Inter',sans-serif}*{box-sizing:border-box;margin:0;padding:0}html,body{height:100%;overflow:hidden}body{font-family:var(--font-body);font-size:14px}h1,h2,h3,.font-display{font-family:var(--font-display)}::-webkit-scrollbar{width:8px}::-webkit-scrollbar-thumb{background:rgba(0,0,0,0.15);border-radius:4px}@keyframes fadeIn{from{opacity:0}to{opacity:1}}@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}.fade-in{animation:fadeIn .3s}.pulse{animation:pulse 2s infinite}.btn-icon{width:36px;height:36px;display:flex;align-items:center;justify-content:center;border-radius:8px;border:none;background:transparent;cursor:pointer}.truncate{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}`;
const Icon={Calendar:({s=24,c="currentColor"})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke={c} strokeWidth="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>,ChevronL:({s=24,c="currentColor"})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke={c} strokeWidth="2"><polyline points="15 18 9 12 15 6"/></svg>,ChevronR:({s=24,c="currentColor"})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke={c} strokeWidth="2"><polyline points="9 18 15 12 9 6"/></svg>,Plus:({s=24,c="currentColor"})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke={c} strokeWidth="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,Settings:({s=24,c="currentColor"})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke={c} strokeWidth="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>,X:({s=24,c="currentColor"})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke={c} strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,Search:({s=24,c="currentColor"})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke={c} strokeWidth="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>,Trash:({s=24,c="currentColor"})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke={c} strokeWidth="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>,Restore:({s=24,c="currentColor"})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke={c} strokeWidth="2"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg>,Sun:({s=24,c="currentColor"})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke={c} strokeWidth="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/></svg>,Moon:({s=24,c="currentColor"})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke={c} strokeWidth="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>,User:({s=24,c="currentColor"})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke={c} strokeWidth="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,Users:({s=24,c="currentColor"})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke={c} strokeWidth="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,Quote:({s=24,c="currentColor"})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke={c} strokeWidth="2"><path d="M3 21c3 0 7-1 7-8V5c0-1.25-.756-2.017-2-2H4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2 1 0 1 0 1 1v1c0 1-1 2-2 2s-1 .008-1 1.031V21c0 1 0 1 1 1z"/><path d="M15 21c3 0 7-1 7-8V5c0-1.25-.757-2.017-2-2h-4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2h.75c0 2.25.25 4-2.75 4v3c0 1 0 1 1 1z"/></svg>,LogOut:({s=24,c="currentColor"})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke={c} strokeWidth="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>,Menu:({s=24,c="currentColor"})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke={c} strokeWidth="2"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>,Sidebar:({s=24,c="currentColor"})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke={c} strokeWidth="2"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="9" y1="3" x2="9" y2="21"/></svg>,Tag:({s=24,c="currentColor"})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke={c} strokeWidth="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>,Edit:({s=24,c="currentColor"})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke={c} strokeWidth="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>,MapPin:({s=24,c="currentColor"})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke={c} strokeWidth="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>,Check:({s=24,c="currentColor"})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke={c} strokeWidth="2"><polyline points="20 6 9 17 4 12"/></svg>,Alert:({s=24,c="currentColor"})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke={c} strokeWidth="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>,Archive:({s=24,c="currentColor"})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke={c} strokeWidth="2"><polyline points="21 8 21 21 3 21 3 8"/><rect x="1" y="3" width="22" height="5"/><line x1="10" y1="12" x2="14" y2="12"/></svg>};

const getGreeting=()=>{const h=new Date().getHours();return h<12?"Good morning":h<17?"Good afternoon":"Good evening"};
const isToday=d=>new Date(d).toDateString()===new Date().toDateString();
const isSameDay=(d1,d2)=>new Date(d1).toDateString()===new Date(d2).toDateString();
const fmtDate=(d,f="full")=>{const o={full:{weekday:"long",year:"numeric",month:"long",day:"numeric"},short:{month:"short",day:"numeric"},monthYear:{month:"long",year:"numeric"}};return new Date(d).toLocaleDateString("en-US",o[f])};
const fmtTime=(d,h24)=>new Date(d).toLocaleTimeString("en-US",{hour:h24?"2-digit":"numeric",minute:"2-digit",hour12:!h24});
const addDays=(d,n)=>{const r=new Date(d);r.setDate(r.getDate()+n);return r};
const addMonths=(d,n)=>{const r=new Date(d);r.setMonth(r.getMonth()+n);return r};
const getWeekStart=(d,mon=true)=>{const r=new Date(d);const day=r.getDay();r.setDate(r.getDate()-(mon?(day===0?6:day-1):day));r.setHours(0,0,0,0);return r};
const getWeekDays=(d,mon=true)=>{const s=getWeekStart(d,mon);return Array.from({length:7},(_,i)=>addDays(s,i))};
const getDaysInMonth=d=>new Date(d.getFullYear(),d.getMonth()+1,0).getDate();
const hex2rgba=(hex,a=1)=>{const m=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);return m?`rgba(${parseInt(m[1],16)},${parseInt(m[2],16)},${parseInt(m[3],16)},${a})`:hex};

export default function Timeline(){
const[user,setUser]=useState(null);const[authLoading,setAuthLoading]=useState(true);const[events,setEvents]=useState([]);const[deletedEvents,setDeletedEvents]=useState([]);const[loading,setLoading]=useState(false);const[currentDate,setCurrentDate]=useState(new Date());const[now,setNow]=useState(new Date());const[view,setView]=useState("day");const[space,setSpace]=useState("personal");const[sidebarOpen,setSidebarOpen]=useState(true);const[showModal,setShowModal]=useState(false);const[showSettings,setShowSettings]=useState(false);const[showDeleted,setShowDeleted]=useState(false);const[showTags,setShowTags]=useState(false);const[editing,setEditing]=useState(null);const[search,setSearch]=useState("");const[notifications,setNotifications]=useState([]);const[settings,setSettings]=useState(()=>{try{return JSON.parse(localStorage.getItem("timeline_settings"))||{darkMode:false,use24Hour:false,weekStartMon:true,categories:CATS}}catch{return{darkMode:false,use24Hour:false,weekStartMon:true,categories:CATS}}});const[filters,setFilters]=useState(()=>CATS.map(c=>c.id));const[drag,setDrag]=useState(null);const[quote]=useState(()=>QUOTES[Math.floor(Math.random()*QUOTES.length)]);const scrollRef=useRef(null);const theme=settings.darkMode?DARK:LIGHT;const cats=settings.categories||CATS;

useEffect(()=>{const s=document.createElement("style");s.textContent=CSS;document.head.appendChild(s);return()=>s.remove()},[]);
useEffect(()=>{setPersistence(auth,browserLocalPersistence);return auth.onAuthStateChanged(u=>{setUser(u);setAuthLoading(false);if(u){loadEvents();loadDeleted()}})},[]);
useEffect(()=>{const t=setInterval(()=>setNow(new Date()),60000);return()=>clearInterval(t)},[]);
useEffect(()=>{localStorage.setItem("timeline_settings",JSON.stringify(settings))},[settings]);
useEffect(()=>{if((view==="day"||view==="week")&&scrollRef.current)setTimeout(()=>{scrollRef.current.scrollTop=8*CFG.hourH},100)},[view]);
useEffect(()=>{if(user){loadEvents();loadDeleted()}},[space]);

const loadEvents=async()=>{if(!user)return;setLoading(true);try{const q=query(collection(db,"events"),where("spaceId","==",space==="personal"?APP.spaceId:APP.familySpaceId),where("deleted","==",false));const snap=await getDocs(q);setEvents(snap.docs.map(d=>({id:d.id,...d.data(),start:d.data().startTime?.toDate(),end:d.data().endTime?.toDate()})))}catch(e){console.error(e)}setLoading(false)};
const loadDeleted=async()=>{if(!user)return;try{const q=query(collection(db,"events"),where("spaceId","==",space==="personal"?APP.spaceId:APP.familySpaceId),where("deleted","==",true));const snap=await getDocs(q);setDeletedEvents(snap.docs.map(d=>({id:d.id,...d.data(),start:d.data().startTime?.toDate(),end:d.data().endTime?.toDate()})))}catch(e){console.error(e)}};
const notify=(msg,type="info")=>{const id=Date.now();setNotifications(p=>[...p,{id,msg,type}]);setTimeout(()=>setNotifications(p=>p.filter(n=>n.id!==id)),4000)};
const saveEvent=async(data)=>{if(!user)return;try{const p={spaceId:space==="personal"?APP.spaceId:APP.familySpaceId,title:data.title,description:data.description||"",location:data.location||"",category:data.category,startTime:Timestamp.fromDate(data.start),endTime:Timestamp.fromDate(data.end),allDay:data.allDay||false,deleted:false,updatedAt:serverTimestamp()};if(data.id){await updateDoc(doc(db,"events",data.id),p);notify("Updated","success")}else{p.createdAt=serverTimestamp();p.createdBy=user.uid;await addDoc(collection(db,"events"),p);notify("Created","success")}setShowModal(false);setEditing(null);loadEvents()}catch{notify("Failed","error")}};
const softDelete=async id=>{await updateDoc(doc(db,"events",id),{deleted:true,deletedAt:serverTimestamp()});notify("Deleted","success");setShowModal(false);loadEvents();loadDeleted()};
const restore=async id=>{await updateDoc(doc(db,"events",id),{deleted:false,deletedAt:null});notify("Restored","success");loadEvents();loadDeleted()};
const permDelete=async id=>{await deleteDoc(doc(db,"events",id));notify("Permanently deleted","success");loadDeleted()};
const updateTimes=async(id,s,e)=>{try{await updateDoc(doc(db,"events",id),{startTime:Timestamp.fromDate(s),endTime:Timestamp.fromDate(e)});loadEvents()}catch{notify("Failed","error")}};

const filtered=useMemo(()=>events.filter(e=>filters.includes(e.category)&&(!search||e.title?.toLowerCase().includes(search.toLowerCase()))),[events,filters,search]);
const upcoming=useMemo(()=>filtered.filter(e=>new Date(e.start)>=new Date()).sort((a,b)=>new Date(a.start)-new Date(b.start)).slice(0,5),[filtered]);
const dayEvents=useMemo(()=>filtered.filter(e=>isSameDay(e.start,currentDate)),[filtered,currentDate]);
const weekEvents=useMemo(()=>{const ws=getWeekStart(currentDate,settings.weekStartMon);const we=addDays(ws,7);return filtered.filter(e=>{const es=new Date(e.start);return es>=ws&&es<we})},[filtered,currentDate,settings.weekStartMon]);
const nav=n=>{const d=new Date(currentDate);if(view==="year")d.setFullYear(d.getFullYear()+n);else if(view==="month")d.setMonth(d.getMonth()+n);else if(view==="week")d.setDate(d.getDate()+n*7);else d.setDate(d.getDate()+n);setCurrentDate(d)};

const onDragStart=(e,ev,mode)=>{if(e.button!==0)return;e.stopPropagation();setDrag({id:ev.id,mode,startY:e.clientY,origStart:new Date(ev.start),origEnd:new Date(ev.end)})};
const onDragMove=useCallback(e=>{if(!drag)return;const diff=Math.round((e.clientY-drag.startY)/CFG.ppm/CFG.snap)*CFG.snap;if(diff===0)return;setEvents(p=>p.map(ev=>{if(ev.id!==drag.id)return ev;const s=new Date(drag.origStart);const en=new Date(drag.origEnd);if(drag.mode==="move"){s.setMinutes(s.getMinutes()+diff);en.setMinutes(en.getMinutes()+diff)}else{en.setMinutes(en.getMinutes()+diff);if(en-s<15*60000)return ev}return{...ev,start:s,end:en}}))},[drag]);
const onDragEnd=useCallback(async()=>{if(!drag)return;const ev=events.find(e=>e.id===drag.id);if(ev)await updateTimes(ev.id,ev.start,ev.end);setDrag(null)},[drag,events]);
useEffect(()=>{if(drag){window.addEventListener("mousemove",onDragMove);window.addEventListener("mouseup",onDragEnd)}return()=>{window.removeEventListener("mousemove",onDragMove);window.removeEventListener("mouseup",onDragEnd)}},[drag,onDragMove,onDragEnd]);

if(authLoading)return<div style={{display:"flex",alignItems:"center",justifyContent:"center",height:"100vh",background:theme.bg}}><div className="pulse" style={{textAlign:"center"}}><div style={{width:64,height:64,borderRadius:16,background:`linear-gradient(135deg,${theme.accent},${theme.accentHover})`,display:"flex",alignItems:"center",justifyContent:"center",margin:"0 auto 16px"}}><Icon.Calendar s={32} c="#fff"/></div><h2 className="font-display" style={{fontSize:28,color:theme.text}}>{APP.name}</h2></div></div>;
if(!user)return<div style={{minHeight:"100vh",background:theme.bg,display:"flex",alignItems:"center",justifyContent:"center"}}><div className="fade-in" style={{textAlign:"center",padding:40}}><div style={{display:"flex",alignItems:"center",justifyContent:"center",gap:16,marginBottom:24}}><div style={{width:64,height:64,borderRadius:16,background:`linear-gradient(135deg,${theme.accent},${theme.accentHover})`,display:"flex",alignItems:"center",justifyContent:"center"}}><Icon.Calendar s={32} c="#fff"/></div><h1 className="font-display" style={{fontSize:48,color:theme.text}}>{APP.name}</h1></div><p style={{fontSize:18,color:theme.textSec,marginBottom:32}}>{APP.tagline}</p><div style={{background:theme.card,borderRadius:16,padding:24,marginBottom:32,border:`1px solid ${theme.border}`,maxWidth:400,margin:"0 auto 32px"}}><Icon.Quote s={20} c={theme.accent}/><p style={{fontSize:16,fontStyle:"italic",color:theme.text,margin:"12px 0"}}>"{quote.text}"</p><p style={{fontSize:14,color:theme.textSec}}>â€” {quote.author}</p></div><button onClick={()=>signInWithPopup(auth,provider)} style={{padding:"16px 48px",borderRadius:12,background:`linear-gradient(135deg,${theme.accent},${theme.accentHover})`,color:"#fff",border:"none",fontSize:16,fontWeight:600,cursor:"pointer"}}>Enter Your Timeline</button></div></div>;

const weekDays=getWeekDays(currentDate,settings.weekStartMon);
return(<div style={{display:"flex",height:"100vh",background:theme.bg,color:theme.text}}>
<aside style={{width:sidebarOpen?300:0,overflow:"hidden",background:theme.sidebar,borderRight:sidebarOpen?`1px solid ${theme.border}`:"none",display:"flex",flexDirection:"column",transition:"width .3s",flexShrink:0}}>
<div style={{padding:"20px 16px",borderBottom:`1px solid ${theme.border}`}}>
<div style={{display:"flex",alignItems:"center",gap:12,marginBottom:16}}><div style={{width:36,height:36,borderRadius:10,background:`linear-gradient(135deg,${theme.accent},${theme.accentHover})`,display:"flex",alignItems:"center",justifyContent:"center"}}><Icon.Calendar s={18} c="#fff"/></div><h1 className="font-display" style={{fontSize:20,fontWeight:700,flex:1}}>{APP.name}</h1><button onClick={()=>setSidebarOpen(false)} className="btn-icon" style={{color:theme.textSec}}><Icon.X s={18}/></button></div>
<div style={{background:theme.bg,borderRadius:10,padding:12,marginBottom:12}}><p style={{fontSize:12,color:theme.textSec}}>{getGreeting()},</p><p className="font-display" style={{fontSize:18,fontWeight:600}}>{user?.displayName?.split(" ")[0]||"there"}! ðŸ‘‹</p></div>
<button onClick={()=>{setEditing(null);setShowModal(true)}} style={{width:"100%",padding:"12px",borderRadius:10,background:`linear-gradient(135deg,${theme.accent},${theme.accentHover})`,color:"#fff",border:"none",fontSize:14,fontWeight:600,cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",gap:8}}><Icon.Plus s={16}/>New Event</button>
</div>
<div style={{flex:1,overflow:"auto",padding:16}}>
<div style={{display:"flex",gap:8,marginBottom:16,background:theme.bg,padding:4,borderRadius:8}}><button onClick={()=>setSpace("personal")} style={{flex:1,padding:8,borderRadius:6,border:"none",fontSize:12,fontWeight:600,cursor:"pointer",background:space==="personal"?theme.card:"transparent",color:space==="personal"?theme.accent:theme.textSec}}><Icon.User s={14}/>Personal</button><button onClick={()=>setSpace("family")} style={{flex:1,padding:8,borderRadius:6,border:"none",fontSize:12,fontWeight:600,cursor:"pointer",background:space==="family"?theme.card:"transparent",color:space==="family"?theme.accent:theme.textSec}}><Icon.Users s={14}/>Family</button></div>
<div style={{position:"relative",marginBottom:16}}><Icon.Search s={14} c={theme.textMuted} style={{position:"absolute",left:10,top:"50%",transform:"translateY(-50%)"}}/><input placeholder="Search..." value={search} onChange={e=>setSearch(e.target.value)} style={{width:"100%",padding:"8px 8px 8px 32px",borderRadius:8,border:`1px solid ${theme.border}`,background:theme.card,color:theme.text,fontSize:13,outline:"none"}}/></div>
<div style={{background:theme.card,borderRadius:10,padding:12,border:`1px solid ${theme.border}`,marginBottom:16}}>
<div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:12}}><button onClick={()=>setCurrentDate(addMonths(currentDate,-1))} className="btn-icon" style={{color:theme.textSec,width:24,height:24}}><Icon.ChevronL s={14}/></button><span style={{fontSize:13,fontWeight:600}}>{fmtDate(currentDate,"monthYear")}</span><button onClick={()=>setCurrentDate(addMonths(currentDate,1))} className="btn-icon" style={{color:theme.textSec,width:24,height:24}}><Icon.ChevronR s={14}/></button></div>
<div style={{display:"grid",gridTemplateColumns:"repeat(7,1fr)",gap:2}}>{(settings.weekStartMon?["M","T","W","T","F","S","S"]:["S","M","T","W","T","F","S"]).map((l,i)=><div key={i} style={{textAlign:"center",fontSize:10,color:theme.textMuted,padding:4}}>{l}</div>)}{(()=>{const first=new Date(currentDate.getFullYear(),currentDate.getMonth(),1);let start=first.getDay();if(settings.weekStartMon)start=start===0?6:start-1;const arr=[];for(let i=0;i<start;i++)arr.push(null);for(let d=1;d<=getDaysInMonth(currentDate);d++)arr.push(new Date(currentDate.getFullYear(),currentDate.getMonth(),d));return arr})().map((d,i)=>d?<button key={i} onClick={()=>{setCurrentDate(d);setView("day")}} style={{aspectRatio:"1",display:"flex",alignItems:"center",justifyContent:"center",borderRadius:6,border:"none",fontSize:11,fontWeight:isToday(d)?700:500,cursor:"pointer",background:isSameDay(d,currentDate)?theme.accent:isToday(d)?theme.accentLight:"transparent",color:isSameDay(d,currentDate)?"#fff":isToday(d)?theme.accent:theme.text}}>{d.getDate()}</button>:<div key={i}/>)}</div>
</div>
<div style={{marginBottom:16}}><div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:8}}><span style={{fontSize:11,fontWeight:700,color:theme.textMuted,textTransform:"uppercase"}}>Categories</span><button onClick={()=>setShowTags(true)} className="btn-icon" style={{color:theme.textSec,width:20,height:20}}><Icon.Edit s={12}/></button></div>{cats.map(c=><div key={c.id} onClick={()=>setFilters(p=>p.includes(c.id)?p.filter(x=>x!==c.id):[...p,c.id])} style={{display:"flex",alignItems:"center",gap:10,padding:"8px 10px",borderRadius:6,cursor:"pointer",opacity:filters.includes(c.id)?1:0.4,background:filters.includes(c.id)?theme.bg:"transparent"}}><div style={{width:8,height:8,borderRadius:"50%",background:c.color}}/><span style={{flex:1,fontSize:13}}>{c.name}</span>{c.icon&&<span style={{fontSize:12}}>{c.icon}</span>}</div>)}</div>
<div style={{marginBottom:16}}><span style={{display:"block",fontSize:11,fontWeight:700,color:theme.textMuted,textTransform:"uppercase",marginBottom:8}}>Upcoming</span>{upcoming.length===0?<p style={{fontSize:12,color:theme.textMuted,textAlign:"center",padding:16}}>No upcoming events</p>:upcoming.map(ev=>{const cat=cats.find(c=>c.id===ev.category);return<div key={ev.id} onClick={()=>{setEditing(ev);setShowModal(true)}} style={{display:"flex",gap:10,padding:10,borderRadius:8,border:`1px solid ${theme.border}`,background:theme.card,cursor:"pointer",marginBottom:6}}><div style={{width:3,borderRadius:2,background:cat?.color||theme.accent}}/><div style={{flex:1,minWidth:0}}><p className="truncate" style={{fontSize:13,fontWeight:600}}>{ev.title||"Untitled"}</p><p style={{fontSize:11,color:theme.textSec}}>{fmtDate(ev.start,"short")} â€¢ {fmtTime(ev.start,settings.use24Hour)}</p></div></div>})}</div>
<div style={{background:hex2rgba(theme.accent,0.08),borderRadius:10,padding:12}}><div style={{display:"flex",alignItems:"center",gap:6,marginBottom:8}}><Icon.Quote s={14} c={theme.accent}/><span style={{fontSize:10,fontWeight:700,color:theme.accent,textTransform:"uppercase"}}>Inspiration</span></div><p style={{fontSize:12,fontStyle:"italic",lineHeight:1.5}}>"{quote.text}"</p><p style={{fontSize:11,color:theme.textSec,marginTop:4}}>â€” {quote.author}</p></div>
</div>
<div style={{padding:"12px 16px",borderTop:`1px solid ${theme.border}`,display:"flex",gap:8}}><button onClick={()=>setShowDeleted(true)} className="btn-icon" style={{color:theme.textSec}}><Icon.Trash s={16}/></button><button onClick={()=>setShowSettings(true)} className="btn-icon" style={{color:theme.textSec}}><Icon.Settings s={16}/></button><div style={{flex:1}}/><button onClick={()=>setSidebarOpen(false)} className="btn-icon" style={{color:theme.textSec}}><Icon.Sidebar s={16}/></button></div>
</aside>
{!sidebarOpen&&<button onClick={()=>setSidebarOpen(true)} style={{position:"fixed",left:0,top:"50%",transform:"translateY(-50%)",width:24,height:56,background:theme.accent,border:"none",borderRadius:"0 8px 8px 0",color:"#fff",cursor:"pointer",zIndex:50}}><Icon.ChevronR s={16}/></button>}
<main style={{flex:1,display:"flex",flexDirection:"column",overflow:"hidden"}}>
<header style={{height:64,background:theme.card,borderBottom:`1px solid ${theme.border}`,display:"flex",alignItems:"center",justifyContent:"space-between",padding:"0 20px",gap:16}}>
<div style={{display:"flex",alignItems:"center",gap:12}}>{!sidebarOpen&&<button onClick={()=>setSidebarOpen(true)} className="btn-icon" style={{color:theme.textSec}}><Icon.Menu s={18}/></button>}
<div style={{display:"flex",background:theme.bg,padding:3,borderRadius:8,border:`1px solid ${theme.border}`}}>{["Day","Week","Month","Year"].map(m=><button key={m} onClick={()=>setView(m.toLowerCase())} style={{padding:"6px 12px",borderRadius:6,border:"none",fontSize:12,fontWeight:600,cursor:"pointer",background:view===m.toLowerCase()?theme.card:"transparent",color:view===m.toLowerCase()?theme.accent:theme.textSec}}>{m}</button>)}</div>
<div style={{display:"flex",alignItems:"center",gap:6}}><button onClick={()=>nav(-1)} className="btn-icon" style={{color:theme.text,border:`1px solid ${theme.border}`,background:theme.card,width:32,height:32}}><Icon.ChevronL s={16}/></button><button onClick={()=>setCurrentDate(new Date())} style={{padding:"6px 12px",borderRadius:6,border:`1px solid ${theme.border}`,background:theme.card,color:theme.text,fontSize:12,fontWeight:600,cursor:"pointer"}}>Today{isToday(currentDate)&&<span className="pulse" style={{display:"inline-block",width:6,height:6,borderRadius:"50%",background:theme.accent,marginLeft:6}}/>}</button><button onClick={()=>nav(1)} className="btn-icon" style={{color:theme.text,border:`1px solid ${theme.border}`,background:theme.card,width:32,height:32}}><Icon.ChevronR s={16}/></button></div>
<h2 className="font-display" style={{fontSize:18,fontWeight:600}}>{view==="year"?currentDate.getFullYear():view==="month"?fmtDate(currentDate,"monthYear"):view==="week"?`${fmtDate(getWeekStart(currentDate,settings.weekStartMon),"short")} - ${fmtDate(addDays(getWeekStart(currentDate,settings.weekStartMon),6),"short")}`:fmtDate(currentDate,"full")}</h2>
</div>
<div style={{display:"flex",alignItems:"center",gap:10}}><button onClick={()=>{setEditing(null);setShowModal(true)}} style={{padding:"8px 16px",borderRadius:8,background:`linear-gradient(135deg,${theme.accent},${theme.accentHover})`,color:"#fff",border:"none",fontSize:13,fontWeight:600,cursor:"pointer",display:"flex",alignItems:"center",gap:6}}><Icon.Plus s={14}/>New</button><div style={{width:36,height:36,borderRadius:"50%",background:theme.accent,color:"#fff",display:"flex",alignItems:"center",justifyContent:"center",fontSize:14,fontWeight:700}}>{user?.displayName?.[0]||"U"}</div></div>
</header>
<div ref={scrollRef} style={{flex:1,overflow:"auto",position:"relative"}}>
{view==="day"&&<DayView theme={theme} date={currentDate} events={dayEvents} cats={cats} now={now} settings={settings} onEdit={ev=>{setEditing(ev);setShowModal(true)}} onCreate={(s,e)=>{setEditing({start:s,end:e,title:"",category:cats[0]?.id});setShowModal(true)}} onDragStart={onDragStart} drag={drag}/>}
{view==="week"&&<WeekView theme={theme} date={currentDate} events={weekEvents} cats={cats} now={now} settings={settings} weekDays={weekDays} onEdit={ev=>{setEditing(ev);setShowModal(true)}} onCreate={(s,e)=>{setEditing({start:s,end:e,title:"",category:cats[0]?.id});setShowModal(true)}} onDateSelect={d=>{setCurrentDate(d);setView("day")}} onDragStart={onDragStart} drag={drag}/>}
{view==="month"&&<MonthView theme={theme} date={currentDate} events={filtered} cats={cats} settings={settings} onDateSelect={d=>{setCurrentDate(d);setView("day")}} onEdit={ev=>{setEditing(ev);setShowModal(true)}}/>}
{view==="year"&&<YearView theme={theme} date={currentDate} events={filtered} cats={cats} settings={settings} onDateSelect={d=>{setCurrentDate(d);setView("day")}}/>}
</div>
{loading&&<div style={{position:"fixed",bottom:20,left:"50%",transform:"translateX(-50%)",background:theme.card,padding:"10px 20px",borderRadius:10,boxShadow:theme.shadowHover,fontSize:12}}>Loading...</div>}
</main>
{showModal&&<EventModal theme={theme} event={editing} cats={cats} settings={settings} onSave={saveEvent} onDelete={editing?.id?()=>softDelete(editing.id):null} onClose={()=>{setShowModal(false);setEditing(null)}}/>}
{showSettings&&<SettingsModal theme={theme} settings={settings} setSettings={setSettings} onSignOut={()=>signOut(auth)} onClose={()=>setShowSettings(false)}/>}
{showDeleted&&<DeletedModal theme={theme} events={deletedEvents} cats={cats} settings={settings} onRestore={restore} onPermDelete={permDelete} onClose={()=>setShowDeleted(false)}/>}
{showTags&&<TagsModal theme={theme} cats={cats} onAdd={c=>setSettings(p=>({...p,categories:[...(p.categories||CATS),{...c,id:Date.now().toString()}]}))} onDelete={id=>setSettings(p=>({...p,categories:(p.categories||CATS).filter(x=>x.id!==id)}))} onClose={()=>setShowTags(false)}/>}
<div style={{position:"fixed",bottom:20,right:20,display:"flex",flexDirection:"column",gap:8,zIndex:2000}}>{notifications.map(n=><div key={n.id} className="fade-in" onClick={()=>setNotifications(p=>p.filter(x=>x.id!==n.id))} style={{padding:"12px 16px",borderRadius:10,background:n.type==="error"?theme.error:n.type==="success"?theme.success:theme.card,color:n.type==="info"?theme.text:"#fff",fontSize:13,fontWeight:600,boxShadow:theme.shadowHover,cursor:"pointer",display:"flex",alignItems:"center",gap:8}}>{n.type==="success"&&<Icon.Check s={16}/>}{n.type==="error"&&<Icon.Alert s={16}/>}{n.msg}</div>)}</div>
</div>)}

function DayView({theme,date,events,cats,now,settings,onEdit,onCreate,onDragStart,drag}){const isTd=isToday(date);const timePos=isTd?((now.getHours()*60+now.getMinutes())/60)*CFG.hourH:null;const hours=Array.from({length:24},(_,i)=>i);return<div style={{display:"flex",minHeight:24*CFG.hourH}}><div style={{width:60,flexShrink:0,borderRight:`1px solid ${theme.border}`,background:theme.card}}>{hours.map(h=><div key={h} style={{height:CFG.hourH,position:"relative",borderBottom:`1px solid ${theme.grid}`}}><span style={{position:"absolute",top:-8,right:8,fontSize:11,color:theme.textMuted}}>{fmtTime(new Date().setHours(h,0),settings.use24Hour)}</span></div>)}</div><div style={{flex:1,position:"relative",background:isTd?hex2rgba(theme.accent,0.02):"transparent"}}>{hours.map(h=><div key={h} onClick={()=>{const s=new Date(date);s.setHours(h,0,0,0);const e=new Date(s);e.setHours(h+1);onCreate(s,e)}} style={{height:CFG.hourH,borderBottom:`1px solid ${theme.grid}`,cursor:"pointer"}}><div style={{height:"50%",borderBottom:`1px dashed ${theme.grid}`}}/></div>)}{isTd&&timePos!==null&&<div style={{position:"absolute",top:timePos,left:0,right:0,height:2,background:theme.accent,zIndex:20,pointerEvents:"none"}}><div className="pulse" style={{position:"absolute",left:-5,top:-4,width:10,height:10,borderRadius:"50%",background:theme.accent}}/></div>}{events.map(ev=>{const cat=cats.find(c=>c.id===ev.category);const top=((ev.start.getHours()*60+ev.start.getMinutes())/60)*CFG.hourH;const h=Math.max(((ev.end-ev.start)/60000/60)*CFG.hourH,28);const isDrag=drag?.id===ev.id;return<div key={ev.id} onMouseDown={e=>onDragStart(e,ev,"move")} onClick={e=>{e.stopPropagation();if(!drag)onEdit(ev)}} className="fade-in" style={{position:"absolute",top,left:6,right:6,height:h,background:settings.darkMode?cat?.darkBg||theme.accentLight:cat?.lightBg||theme.accentLight,borderLeft:`3px solid ${cat?.color||theme.accent}`,borderRadius:6,padding:"6px 10px",cursor:isDrag?"grabbing":"grab",boxShadow:isDrag?theme.shadowHover:theme.shadow,zIndex:isDrag?100:10,overflow:"hidden"}}><p className="truncate" style={{fontSize:13,fontWeight:600,color:settings.darkMode?"#fff":cat?.color||theme.accent}}>{ev.title||"Untitled"}</p>{h>40&&<p style={{fontSize:11,color:theme.textSec}}>{fmtTime(ev.start,settings.use24Hour)} - {fmtTime(ev.end,settings.use24Hour)}</p>}{h>60&&ev.location&&<p className="truncate" style={{fontSize:11,color:theme.textMuted,marginTop:2}}><Icon.MapPin s={10}/> {ev.location}</p>}<div onMouseDown={e=>{e.stopPropagation();onDragStart(e,ev,"resize")}} style={{position:"absolute",bottom:0,left:0,right:0,height:6,cursor:"ns-resize"}}/></div>})}</div></div>}

function WeekView({theme,date,events,cats,now,settings,weekDays,onEdit,onCreate,onDateSelect,onDragStart,drag}){const hours=Array.from({length:24},(_,i)=>i);return<div style={{display:"flex",flexDirection:"column",minHeight:"100%"}}><div style={{display:"flex",borderBottom:`1px solid ${theme.border}`,background:theme.card,position:"sticky",top:0,zIndex:20}}><div style={{width:60,flexShrink:0,borderRight:`1px solid ${theme.border}`}}/>{weekDays.map((d,i)=>{const isTd=isToday(d);return<div key={i} onClick={()=>onDateSelect(d)} style={{flex:1,padding:"10px 6px",textAlign:"center",borderRight:`1px solid ${theme.border}`,cursor:"pointer",background:isTd?hex2rgba(theme.accent,0.05):"transparent"}}><div style={{fontSize:10,fontWeight:700,color:isTd?theme.accent:theme.textMuted,textTransform:"uppercase"}}>{d.toLocaleDateString("en-US",{weekday:"short"})}</div><div style={{fontSize:18,fontWeight:600,color:isTd?theme.accent:theme.text}}>{d.getDate()}{isTd&&<span className="pulse" style={{display:"inline-block",width:6,height:6,borderRadius:"50%",background:theme.accent,marginLeft:4}}/>}</div></div>})}</div><div style={{display:"flex",flex:1}}><div style={{width:60,flexShrink:0,borderRight:`1px solid ${theme.border}`,background:theme.card}}>{hours.map(h=><div key={h} style={{height:CFG.weekHourH,position:"relative",borderBottom:`1px solid ${theme.grid}`}}><span style={{position:"absolute",top:-7,right:6,fontSize:10,color:theme.textMuted}}>{fmtTime(new Date().setHours(h,0),settings.use24Hour)}</span></div>)}</div>{weekDays.map((d,di)=>{const isTd=isToday(d);const dayEv=events.filter(e=>isSameDay(e.start,d));return<div key={di} style={{flex:1,position:"relative",borderRight:`1px solid ${theme.border}`,background:isTd?hex2rgba(theme.accent,0.02):"transparent"}}>{hours.map(h=><div key={h} onClick={()=>{const s=new Date(d);s.setHours(h,0,0,0);const e=new Date(s);e.setHours(h+1);onCreate(s,e)}} style={{height:CFG.weekHourH,borderBottom:`1px solid ${theme.grid}`,cursor:"pointer"}}/>)}{isTd&&<div style={{position:"absolute",top:((now.getHours()*60+now.getMinutes())/60)*CFG.weekHourH,left:0,right:0,height:2,background:theme.accent,zIndex:15}}><div className="pulse" style={{position:"absolute",left:-3,top:-3,width:8,height:8,borderRadius:"50%",background:theme.accent}}/></div>}{dayEv.map(ev=>{const cat=cats.find(c=>c.id===ev.category);const top=((ev.start.getHours()*60+ev.start.getMinutes())/60)*CFG.weekHourH;const h=Math.max(((ev.end-ev.start)/60000/60)*CFG.weekHourH,20);const isDrag=drag?.id===ev.id;return<div key={ev.id} onMouseDown={e=>onDragStart(e,ev,"move")} onClick={e=>{e.stopPropagation();if(!drag)onEdit(ev)}} style={{position:"absolute",top,left:2,right:2,height:h,background:settings.darkMode?cat?.darkBg||theme.accentLight:cat?.lightBg||theme.accentLight,borderLeft:`2px solid ${cat?.color||theme.accent}`,borderRadius:3,padding:"2px 4px",cursor:isDrag?"grabbing":"grab",boxShadow:isDrag?theme.shadowHover:theme.shadow,zIndex:isDrag?100:10,overflow:"hidden"}}><p className="truncate" style={{fontSize:10,fontWeight:600,color:settings.darkMode?"#fff":cat?.color||theme.accent}}>{ev.title||"Untitled"}</p></div>})}</div>})}</div></div>}

function MonthView({theme,date,events,cats,settings,onDateSelect,onEdit}){const labels=settings.weekStartMon?["Mon","Tue","Wed","Thu","Fri","Sat","Sun"]:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];const days=useMemo(()=>{const first=new Date(date.getFullYear(),date.getMonth(),1);let start=first.getDay();if(settings.weekStartMon)start=start===0?6:start-1;const arr=[];for(let i=start;i>0;i--)arr.push({d:addDays(first,-i),cur:false});for(let d=1;d<=getDaysInMonth(date);d++)arr.push({d:new Date(date.getFullYear(),date.getMonth(),d),cur:true});while(arr.length%7!==0)arr.push({d:addDays(arr[arr.length-1].d,1),cur:false});return arr},[date,settings.weekStartMon]);return<div style={{padding:20,height:"100%"}}><div style={{display:"grid",gridTemplateColumns:"repeat(7,1fr)",gap:6,marginBottom:12}}>{labels.map((l,i)=><div key={i} style={{textAlign:"center",fontSize:11,fontWeight:700,color:theme.textMuted,textTransform:"uppercase",padding:6}}>{l}</div>)}</div><div style={{display:"grid",gridTemplateColumns:"repeat(7,1fr)",gap:6,height:"calc(100% - 50px)"}}>{days.map(({d,cur},i)=>{const isTd=isToday(d);const dayEv=events.filter(e=>isSameDay(e.start,d));return<div key={i} onClick={()=>onDateSelect(d)} style={{background:theme.card,borderRadius:10,border:`1px solid ${isTd?theme.accent:theme.border}`,padding:10,cursor:"pointer",opacity:cur?1:0.4,display:"flex",flexDirection:"column",overflow:"hidden"}}><div style={{display:"flex",alignItems:"center",gap:4,marginBottom:6}}><span style={{fontSize:14,fontWeight:isTd?700:600,color:isTd?theme.accent:theme.text}}>{d.getDate()}</span>{isTd&&<div className="pulse" style={{width:5,height:5,borderRadius:"50%",background:theme.accent}}/>}</div><div style={{flex:1,display:"flex",flexDirection:"column",gap:3,overflow:"hidden"}}>{dayEv.slice(0,3).map(ev=>{const cat=cats.find(c=>c.id===ev.category);return<div key={ev.id} onClick={e=>{e.stopPropagation();onEdit(ev)}} className="truncate" style={{fontSize:10,padding:"2px 4px",borderRadius:3,background:settings.darkMode?cat?.darkBg||theme.accentLight:cat?.lightBg||theme.accentLight,color:settings.darkMode?"#fff":cat?.color||theme.accent,fontWeight:500}}>{ev.title||"Untitled"}</div>})}{dayEv.length>3&&<span style={{fontSize:9,color:theme.textSec}}>+{dayEv.length-3} more</span>}</div></div>})}</div></div>}

function YearView({theme,date,events,cats,settings,onDateSelect}){const labels=settings.weekStartMon?["M","T","W","T","F","S","S"]:["S","M","T","W","T","F","S"];const months=Array.from({length:12},(_, m)=>{const d=new Date(date.getFullYear(),m,1);let start=d.getDay();if(settings.weekStartMon)start=start===0?6:start-1;return{d,start,days:getDaysInMonth(d)}});return<div className="fade-in" style={{padding:"24px 32px",minHeight:"100%"}}><div style={{display:"flex",marginLeft:80,marginBottom:12}}>{Array.from({length:37}).map((_,i)=><div key={i} style={{flex:1,textAlign:"center",fontSize:10,fontWeight:700,color:theme.textMuted,minWidth:24}}>{labels[i%7]}</div>)}</div>{months.map(({d,start,days},mi)=><div key={mi} style={{display:"flex",alignItems:"center",marginBottom:6,height:28}}><div style={{width:80,fontSize:13,fontWeight:600,color:theme.textSec,flexShrink:0}}>{d.toLocaleDateString("en-US",{month:"short"})}</div><div style={{flex:1,display:"flex",gap:2}}>{Array.from({length:37}).map((_,col)=>{const dn=col-start+1;if(dn<1||dn>days)return<div key={col} style={{flex:1,minWidth:24}}/>;const dd=new Date(date.getFullYear(),mi,dn);const isTd=isToday(dd);const dayEv=events.filter(e=>isSameDay(e.start,dd));const has=dayEv.length>0;return<div key={col} onClick={()=>onDateSelect(dd)} style={{flex:1,minWidth:24,height:24,borderRadius:4,display:"flex",alignItems:"center",justifyContent:"center",fontSize:11,fontWeight:isTd?700:500,cursor:"pointer",position:"relative",background:isTd?theme.accent:has?(settings.darkMode?theme.accentLight:theme.bg):"transparent",color:isTd?"#fff":has?(settings.darkMode?theme.accent:theme.text):theme.text,border:isTd?`2px solid ${theme.accent}`:"none"}}>{dn}{has&&!isTd&&<div style={{position:"absolute",bottom:1,left:"50%",transform:"translateX(-50%)",display:"flex",gap:1}}>{dayEv.slice(0,3).map((ev,i)=>{const cat=cats.find(c=>c.id===ev.category);return<div key={i} style={{width:3,height:3,borderRadius:"50%",background:cat?.color||theme.accent}}/>})}</div>}</div>})}</div></div>)}</div>}

function EventModal({theme,event,cats,settings,onSave,onDelete,onClose}){const[title,setTitle]=useState(event?.title||"");const[desc,setDesc]=useState(event?.description||"");const[loc,setLoc]=useState(event?.location||"");const[cat,setCat]=useState(event?.category||cats[0]?.id);const[sDate,setSDate]=useState(event?.start?new Date(event.start).toISOString().split("T")[0]:new Date().toISOString().split("T")[0]);const[sTime,setSTime]=useState(event?.start?event.start.toTimeString().slice(0,5):"09:00");const[eTime,setETime]=useState(event?.end?event.end.toTimeString().slice(0,5):"10:00");const[allDay,setAllDay]=useState(event?.allDay||false);const submit=()=>{if(!title.trim())return alert("Please enter a title");const s=new Date(sDate);const[sh,sm]=sTime.split(":");s.setHours(parseInt(sh),parseInt(sm),0,0);const e=new Date(sDate);const[eh,em]=eTime.split(":");e.setHours(parseInt(eh),parseInt(em),0,0);if(e<=s)e.setDate(e.getDate()+1);onSave({id:event?.id,title,description:desc,location:loc,category:cat,start:s,end:e,allDay})};return<div className="fade-in" style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.4)",backdropFilter:"blur(4px)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1000,padding:20}} onClick={onClose}><div onClick={e=>e.stopPropagation()} style={{width:"100%",maxWidth:440,background:theme.card,borderRadius:16,boxShadow:theme.shadowHover,border:`1px solid ${theme.border}`,overflow:"hidden"}}><div style={{padding:"16px 20px",borderBottom:`1px solid ${theme.border}`,display:"flex",alignItems:"center",justifyContent:"space-between"}}><h3 className="font-display" style={{fontSize:18,fontWeight:600}}>{event?.id?"Edit Event":"New Event"}</h3><div style={{display:"flex",gap:6}}>{event?.id&&onDelete&&<button onClick={()=>{if(confirm("Move to trash?"))onDelete()}} className="btn-icon" style={{color:theme.error}}><Icon.Trash s={16}/></button>}<button onClick={onClose} className="btn-icon" style={{color:theme.textSec}}><Icon.X s={16}/></button></div></div><div style={{padding:20,display:"flex",flexDirection:"column",gap:16}}><div><label style={{display:"block",fontSize:11,fontWeight:700,color:theme.textMuted,textTransform:"uppercase",marginBottom:6}}>Title</label><input type="text" value={title} onChange={e=>setTitle(e.target.value)} placeholder="Event title" autoFocus style={{width:"100%",padding:"10px 12px",borderRadius:8,border:`1px solid ${theme.border}`,background:theme.bg,color:theme.text,fontSize:14,fontWeight:600,outline:"none"}}/></div><div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:10}}><div><label style={{display:"block",fontSize:11,fontWeight:700,color:theme.textMuted,textTransform:"uppercase",marginBottom:6}}>Date</label><input type="date" value={sDate} onChange={e=>setSDate(e.target.value)} style={{width:"100%",padding:"8px 10px",borderRadius:8,border:`1px solid ${theme.border}`,background:theme.bg,color:theme.text,fontSize:13,outline:"none"}}/></div><div><label style={{display:"block",fontSize:11,fontWeight:700,color:theme.textMuted,textTransform:"uppercase",marginBottom:6}}>Start</label><input type="time" value={sTime} onChange={e=>setSTime(e.target.value)} disabled={allDay} style={{width:"100%",padding:"8px 10px",borderRadius:8,border:`1px solid ${theme.border}`,background:theme.bg,color:theme.text,fontSize:13,outline:"none",opacity:allDay?0.5:1}}/></div><div><label style={{display:"block",fontSize:11,fontWeight:700,color:theme.textMuted,textTransform:"uppercase",marginBottom:6}}>End</label><input type="time" value={eTime} onChange={e=>setETime(e.target.value)} disabled={allDay} style={{width:"100%",padding:"8px 10px",borderRadius:8,border:`1px solid ${theme.border}`,background:theme.bg,color:theme.text,fontSize:13,outline:"none",opacity:allDay?0.5:1}}/></div></div><div style={{display:"flex",alignItems:"center",justifyContent:"space-between"}}><span style={{fontSize:13,fontWeight:500}}>All day</span><div onClick={()=>setAllDay(!allDay)} style={{width:44,height:24,borderRadius:12,background:allDay?theme.accent:theme.border,cursor:"pointer",position:"relative"}}><div style={{position:"absolute",top:2,left:allDay?22:2,width:20,height:20,borderRadius:"50%",background:"#fff",boxShadow:"0 2px 4px rgba(0,0,0,0.2)",transition:".2s"}}/></div></div><div><label style={{display:"block",fontSize:11,fontWeight:700,color:theme.textMuted,textTransform:"uppercase",marginBottom:6}}>Category</label><div style={{display:"flex",flexWrap:"wrap",gap:6}}>{cats.map(c=><button key={c.id} onClick={()=>setCat(c.id)} style={{padding:"6px 12px",borderRadius:16,border:cat===c.id?`2px solid ${c.color}`:`1px solid ${theme.border}`,background:cat===c.id?c.lightBg:"transparent",color:cat===c.id?c.color:theme.text,fontSize:12,fontWeight:600,cursor:"pointer",display:"flex",alignItems:"center",gap:4}}>{c.icon&&<span>{c.icon}</span>}{c.name}</button>)}</div></div><div><label style={{display:"block",fontSize:11,fontWeight:700,color:theme.textMuted,textTransform:"uppercase",marginBottom:6}}>Location</label><div style={{position:"relative"}}><Icon.MapPin s={14} c={theme.textMuted} style={{position:"absolute",left:10,top:"50%",transform:"translateY(-50%)"}}/><input type="text" value={loc} onChange={e=>setLoc(e.target.value)} placeholder="Add location" style={{width:"100%",padding:"8px 10px 8px 32px",borderRadius:8,border:`1px solid ${theme.border}`,background:theme.bg,color:theme.text,fontSize:13,outline:"none"}}/></div></div><div><label style={{display:"block",fontSize:11,fontWeight:700,color:theme.textMuted,textTransform:"uppercase",marginBottom:6}}>Notes</label><textarea value={desc} onChange={e=>setDesc(e.target.value)} placeholder="Add notes..." rows={2} style={{width:"100%",padding:"10px 12px",borderRadius:8,border:`1px solid ${theme.border}`,background:theme.bg,color:theme.text,fontSize:13,outline:"none",resize:"none",fontFamily:"inherit"}}/></div></div><div style={{padding:"12px 20px 20px",display:"flex",justifyContent:"flex-end",gap:10}}><button onClick={onClose} style={{padding:"10px 20px",borderRadius:8,border:"none",background:"transparent",color:theme.textSec,fontSize:13,fontWeight:600,cursor:"pointer"}}>Cancel</button><button onClick={submit} style={{padding:"10px 24px",borderRadius:8,border:"none",background:`linear-gradient(135deg,${theme.accent},${theme.accentHover})`,color:"#fff",fontSize:13,fontWeight:600,cursor:"pointer"}}>{event?.id?"Update":"Create"}</button></div></div></div>}

function SettingsModal({theme,settings,setSettings,onSignOut,onClose}){const upd=(k,v)=>setSettings(p=>({...p,[k]:v}));return<div className="fade-in" style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.4)",backdropFilter:"blur(4px)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1000,padding:20}} onClick={onClose}><div onClick={e=>e.stopPropagation()} style={{width:"100%",maxWidth:400,background:theme.card,borderRadius:16,boxShadow:theme.shadowHover,border:`1px solid ${theme.border}`}}><div style={{padding:"16px 20px",borderBottom:`1px solid ${theme.border}`,display:"flex",alignItems:"center",justifyContent:"space-between"}}><h3 className="font-display" style={{fontSize:18,fontWeight:600}}>Settings</h3><button onClick={onClose} className="btn-icon" style={{color:theme.textSec}}><Icon.X s={16}/></button></div><div style={{padding:20,display:"flex",flexDirection:"column",gap:20}}><div style={{display:"flex",alignItems:"center",justifyContent:"space-between"}}><div><div style={{fontSize:14,fontWeight:600}}>Theme</div><div style={{fontSize:12,color:theme.textSec}}>Light or dark</div></div><div style={{display:"flex",background:theme.bg,padding:3,borderRadius:8,border:`1px solid ${theme.border}`}}><button onClick={()=>upd("darkMode",false)} style={{padding:"6px 10px",borderRadius:5,border:"none",background:!settings.darkMode?theme.card:"transparent",color:!settings.darkMode?theme.text:theme.textSec,fontWeight:600,fontSize:12,cursor:"pointer",display:"flex",alignItems:"center",gap:4}}><Icon.Sun s={12}/>Light</button><button onClick={()=>upd("darkMode",true)} style={{padding:"6px 10px",borderRadius:5,border:"none",background:settings.darkMode?theme.card:"transparent",color:settings.darkMode?theme.text:theme.textSec,fontWeight:600,fontSize:12,cursor:"pointer",display:"flex",alignItems:"center",gap:4}}><Icon.Moon s={12}/>Dark</button></div></div><div style={{display:"flex",alignItems:"center",justifyContent:"space-between"}}><div><div style={{fontSize:14,fontWeight:600}}>24-Hour Time</div><div style={{fontSize:12,color:theme.textSec}}>Military format</div></div><div onClick={()=>upd("use24Hour",!settings.use24Hour)} style={{width:44,height:24,borderRadius:12,background:settings.use24Hour?theme.accent:theme.border,cursor:"pointer",position:"relative"}}><div style={{position:"absolute",top:2,left:settings.use24Hour?22:2,width:20,height:20,borderRadius:"50%",background:"#fff",boxShadow:"0 2px 4px rgba(0,0,0,0.2)",transition:".2s"}}/></div></div><div style={{display:"flex",alignItems:"center",justifyContent:"space-between"}}><div><div style={{fontSize:14,fontWeight:600}}>Week Starts Monday</div><div style={{fontSize:12,color:theme.textSec}}>First day of week</div></div><div onClick={()=>upd("weekStartMon",!settings.weekStartMon)} style={{width:44,height:24,borderRadius:12,background:settings.weekStartMon?theme.accent:theme.border,cursor:"pointer",position:"relative"}}><div style={{position:"absolute",top:2,left:settings.weekStartMon?22:2,width:20,height:20,borderRadius:"50%",background:"#fff",boxShadow:"0 2px 4px rgba(0,0,0,0.2)",transition:".2s"}}/></div></div></div><div style={{padding:"12px 20px 20px",borderTop:`1px solid ${theme.border}`}}><button onClick={onSignOut} style={{width:"100%",padding:"12px",borderRadius:8,border:`1px solid ${theme.error}`,background:"transparent",color:theme.error,fontSize:13,fontWeight:600,cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",gap:6}}><Icon.LogOut s={14}/>Sign Out</button></div></div></div>}

function DeletedModal({theme,events,cats,settings,onRestore,onPermDelete,onClose}){return<div className="fade-in" style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.4)",backdropFilter:"blur(4px)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1000,padding:20}} onClick={onClose}><div onClick={e=>e.stopPropagation()} style={{width:"100%",maxWidth:480,maxHeight:"80vh",background:theme.card,borderRadius:16,boxShadow:theme.shadowHover,border:`1px solid ${theme.border}`,display:"flex",flexDirection:"column"}}><div style={{padding:"16px 20px",borderBottom:`1px solid ${theme.border}`,display:"flex",alignItems:"center",justifyContent:"space-between",flexShrink:0}}><div style={{display:"flex",alignItems:"center",gap:10}}><Icon.Trash s={18} c={theme.textSec}/><h3 className="font-display" style={{fontSize:18,fontWeight:600}}>Deleted Events</h3></div><button onClick={onClose} className="btn-icon" style={{color:theme.textSec}}><Icon.X s={16}/></button></div><div style={{flex:1,overflow:"auto",padding:20}}>{events.length===0?<div style={{textAlign:"center",padding:32,color:theme.textMuted}}><Icon.Archive s={40} c={theme.textMuted}/><p style={{marginTop:12,fontSize:14}}>No deleted events</p></div>:<div style={{display:"flex",flexDirection:"column",gap:10}}>{events.map(ev=>{const cat=cats.find(c=>c.id===ev.category);return<div key={ev.id} style={{display:"flex",alignItems:"center",gap:12,padding:12,borderRadius:10,background:theme.bg,border:`1px solid ${theme.border}`}}><div style={{width:3,height:40,borderRadius:2,background:cat?.color||theme.accent,flexShrink:0}}/><div style={{flex:1,minWidth:0}}><p className="truncate" style={{fontSize:14,fontWeight:600}}>{ev.title||"Untitled"}</p><p style={{fontSize:12,color:theme.textSec}}>{fmtDate(ev.start,"short")} â€¢ {fmtTime(ev.start,settings.use24Hour)}</p></div><div style={{display:"flex",gap:6,flexShrink:0}}><button onClick={()=>onRestore(ev.id)} className="btn-icon" style={{color:theme.success,width:32,height:32}}><Icon.Restore s={14}/></button><button onClick={()=>{if(confirm("Permanently delete?"))onPermDelete(ev.id)}} className="btn-icon" style={{color:theme.error,width:32,height:32}}><Icon.Trash s={14}/></button></div></div>})}</div>}</div></div></div>}

function TagsModal({theme,cats,onAdd,onDelete,onClose}){const[name,setName]=useState("");const[color,setColor]=useState("#059669");const[icon,setIcon]=useState("");const[adding,setAdding]=useState(false);const colors=["#059669","#10B981","#14B8A6","#0EA5E9","#3B82F6","#6366F1","#8B5CF6","#A855F7","#EC4899","#F43F5E","#EF4444","#F97316","#F59E0B","#84CC16"];const add=()=>{if(!name.trim())return;onAdd({name,color,icon,lightBg:hex2rgba(color,0.1),darkBg:hex2rgba(color,0.3)});setName("");setIcon("");setAdding(false)};return<div className="fade-in" style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.4)",backdropFilter:"blur(4px)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1000,padding:20}} onClick={onClose}><div onClick={e=>e.stopPropagation()} style={{width:"100%",maxWidth:440,maxHeight:"80vh",background:theme.card,borderRadius:16,boxShadow:theme.shadowHover,border:`1px solid ${theme.border}`,display:"flex",flexDirection:"column"}}><div style={{padding:"16px 20px",borderBottom:`1px solid ${theme.border}`,display:"flex",alignItems:"center",justifyContent:"space-between",flexShrink:0}}><div style={{display:"flex",alignItems:"center",gap:10}}><Icon.Tag s={18} c={theme.textSec}/><h3 className="font-display" style={{fontSize:18,fontWeight:600}}>Manage Categories</h3></div><button onClick={onClose} className="btn-icon" style={{color:theme.textSec}}><Icon.X s={16}/></button></div><div style={{flex:1,overflow:"auto",padding:20}}><div style={{display:"flex",flexDirection:"column",gap:10}}>{cats.map(c=><div key={c.id} style={{display:"flex",alignItems:"center",gap:10,padding:10,borderRadius:8,background:theme.bg,border:`1px solid ${theme.border}`}}><div style={{width:28,height:28,borderRadius:6,background:c.color,display:"flex",alignItems:"center",justifyContent:"center",fontSize:14,flexShrink:0}}>{c.icon||""}</div><div style={{flex:1}}><p style={{fontSize:13,fontWeight:600}}>{c.name}</p></div><button onClick={()=>{if(confirm(`Delete "${c.name}"?`))onDelete(c.id)}} className="btn-icon" style={{color:theme.error,width:26,height:26}}><Icon.Trash s={12}/></button></div>)}</div>{adding?<div style={{marginTop:14,padding:14,borderRadius:10,background:theme.bg,border:`1px solid ${theme.border}`}}><input type="text" value={name} onChange={e=>setName(e.target.value)} placeholder="Category name" autoFocus style={{width:"100%",padding:"8px 10px",borderRadius:6,border:`1px solid ${theme.border}`,background:theme.card,color:theme.text,fontSize:13,marginBottom:10,outline:"none"}}/><div style={{marginBottom:10}}><label style={{fontSize:11,fontWeight:600,color:theme.textSec,marginBottom:6,display:"block"}}>Color</label><div style={{display:"flex",flexWrap:"wrap",gap:4}}>{colors.map(cl=><button key={cl} onClick={()=>setColor(cl)} style={{width:20,height:20,borderRadius:4,background:cl,border:color===cl?"2px solid #fff":"none",boxShadow:color===cl?`0 0 0 2px ${cl}`:"none",cursor:"pointer"}}/>)}</div></div><input type="text" value={icon} onChange={e=>setIcon(e.target.value)} placeholder="Emoji (optional)" style={{width:"100%",padding:"8px 10px",borderRadius:6,border:`1px solid ${theme.border}`,background:theme.card,color:theme.text,fontSize:13,marginBottom:10,outline:"none"}}/><div style={{display:"flex",gap:6}}><button onClick={()=>setAdding(false)} style={{flex:1,padding:8,borderRadius:6,border:"none",background:"transparent",color:theme.textSec,fontSize:12,fontWeight:600,cursor:"pointer"}}>Cancel</button><button onClick={add} style={{flex:1,padding:8,borderRadius:6,border:"none",background:theme.accent,color:"#fff",fontSize:12,fontWeight:600,cursor:"pointer"}}>Add</button></div></div>:<button onClick={()=>setAdding(true)} style={{width:"100%",marginTop:14,padding:12,borderRadius:8,border:`2px dashed ${theme.border}`,background:"transparent",color:theme.textSec,fontSize:13,fontWeight:600,cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",gap:6}}><Icon.Plus s={14}/>Add Category</button>}</div></div></div>}
